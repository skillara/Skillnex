<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>படி 32: லாகின் (Ban Check)</title>
    <style>
        /* (CSS ஸ்டைல்கள் மாறவில்லை - படி 1-ல் இருந்து அப்படியே) */
        .header {
            background: #fff; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: #333; }
        .nav a { color: #007bff; text-decoration: none; margin-left: 1.5rem; font-weight: 500; }
        #auth-status-nav a { color: #28a745; }
        #logout-btn { color: #dc3545; cursor: pointer; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; }
        .container { background: #fff; margin: 2rem auto; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: 100%; max-width: 400px; box-sizing: border-box; }
        h2 { text-align: center; color: #333; margin-top: 0; }
        .form-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 0.5rem; color: #555; font-weight: 600; }
        input[type="email"], input[type="password"] { 
            width: 100%; padding: 0.8rem; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; 
        }
        button { 
            width: 100%; padding: 1rem; background-color: #007bff; color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-size: 1rem; font-weight: 700;
        }
        button:disabled { background-color: #ccc; }
        #welcome-box { display: none; text-align: center; }
        #welcome-box p { font-size: 1.2rem; word-break: break-all; }
        #welcome-box button { background-color: #dc3545; }
        .form-toggle { text-align: center; margin-top: 1rem; }
        .form-toggle a { color: #007bff; cursor: pointer; text-decoration: underline; }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">SkillNex</div>
        <nav class="nav">
            <a href="index.html">முகப்பு (Home)</a>
            <span id="auth-status-nav">...</span>
            <a id="create-gig-link" href="create-gig.html" style="display: none;">Gig-ஐ உருவாக்கு</a>
            <a id="my-orders-link" href="my-orders.html" style="display: none;">எனது ஆர்டர்கள்</a>
            <a id="messages-link" href="messages.html" style="display: none;">மெசேஜ்கள்</a>
            <a id="profile-link" href="profile.html" style="display: none;">சுயவிவரம்</a>
            <a id="logout-btn" style="display: none;">வெளியேறு (Logout)</a>
        </nav>
    </header>

    <div class="container" id="form-container">
        <div id="welcome-box">
            <p id="user-status">Loading...</p>
            <button id="logout-button-main">வெளியேறு (Logout)</button>
        </div>
        <div id="register-form" style="display:none;">
            <h2>புதிய கணக்கு (Register)</h2>
            <div class.form-group"><label>மின்னஞ்சல்</label><input type="email" id="reg-email"></div>
            <div class.form-group"><label>கடவுச்சொல்</label><input type="password" id="reg-password"></div>
            <button id="reg-btn">பதிவு செய்</button>
        </div>
        <div id="login-form" style="display:none;">
            <h2>உள்நுழை (Login)</h2>
            <div class.form-group"><label>மின்னஞ்சல்</label><input type="email" id="login-email"></div>
            <div class.form-group"><label>கடவுச்சொல்</label><input type="password" id="login-password"></div>
            <button id="login-btn">உள்நுழை</button>
        </div>
        <div class="form-toggle" id="toggle-container" style="display:none;">
            <span id="toggle-text">...</span>
            <a id="toggle-link">...</a>
        </div>
    </div>

    <script type="module">
        // Import the functions you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // !! படி 32: doc மற்றும் getDoc தேவை !!
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase Config... (மாற்றப்படவில்லை)
        const firebaseConfig = {
            apiKey: "AIzaSyDrcT2_lGYtEtnn3LKvp3M7Ou9rTG95XG8",
            authDomain: "skillnex.firebaseapp.com",
            projectId: "skillnex",
            storageBucket: "skillnex.firebasestorage.app",
            messagingSenderId: "981326730889",
            appId: "1:981326730889:web:a063a71ec8b8d2169d9858",
            measurementId: "G-HN4CVQF3GJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // !! படி 32: Firestore-ஐ இணை !!

        // --- DOM Elements (மாற்றப்படவில்லை) ---
        const authStatusNav = document.getElementById('auth-status-nav');
        const createGigLink = document.getElementById('create-gig-link');
        const myOrdersLink = document.getElementById('my-orders-link');
        const messagesLink = document.getElementById('messages-link');
        const profileLink = document.getElementById('profile-link');
        const logoutBtn = document.getElementById('logout-btn');
        const formContainer = document.getElementById('form-container');
        const welcomeBox = document.getElementById('welcome-box');
        const userStatus = document.getElementById('user-status');
        const logoutButtonMain = document.getElementById('logout-button-main');
        const registerForm = document.getElementById('register-form');
        const loginForm = document.getElementById('login-form');
        const toggleContainer = document.getElementById('toggle-container');
        const regBtn = document.getElementById('reg-btn');
        const loginBtn = document.getElementById('login-btn');
        const toggleLinkBtn = document.getElementById('toggle-link');

        function toggleForms() { /* ... (மாற்றப்படவில்லை) ... */ }
        toggleForms();
        
        // --- Register ---
        function handleRegister() {
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            if (!email || !password) { alert("மின்னஞ்சல் மற்றும் கடவுச்சொல் தேவை!"); return; }

            createUserWithEmailAndPassword(auth, email, password)
                .then(async (userCredential) => {
                    // !! படி 32: Register செய்தவுடன் 'users' collection-ல் சேமி !!
                    const user = userCredential.user;
                    const userRef = doc(db, "users", user.uid);
                    await setDoc(userRef, {
                        email: user.email,
                        isBanned: false, // Default-ஆக Ban இல்லை
                        createdAt: serverTimestamp()
                    });
                    
                    alert("வெற்றிகரமாக பதிவு செய்தீர்கள்! இப்போது லாகின் செய்யலாம்.");
                    toggleForms(); // லாகின் ஃபார்மைக் காட்டு
                })
                .catch((error) => { alert("பதிவு செய்யும்போது பிழை: " + error.message); });
        }

        // ===============================================
        // !! படி 32: அப்டேட் செய்யப்பட்ட லாகின் செயல்பாடு !!
        // ===============================================
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) { alert("மின்னஞ்சல் மற்றும் கடவுச்சொல் தேவை!"); return; }

            loginBtn.disabled = true;
            loginBtn.innerText = "சோதிக்கிறது...";

            try {
                // படி 1: Firebase Auth-ல் லாகின் செய்
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                // படி 2: Firestore-ல் யூசர் டாக்குமெண்ட்டைப் படி
                const userRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(userRef);

                if (docSnap.exists() && docSnap.data().isBanned === true) {
                    // !! பிடிபட்டார் !! யூசர் Ban செய்யப்பட்டுள்ளார்.
                    alert("உங்கள் கணக்கு முடக்கப்பட்டுள்ளது (Banned). தயவுசெய்து அட்மினைத் தொடர்புகொள்ளவும்.");
                    
                    // அவரை உடனடியாக Logout செய்
                    await signOut(auth);
                    
                    loginBtn.disabled = false;
                    loginBtn.innerText = "உள்நுழை (Login)";
                    
                } else {
                    // யூசர் Ban செய்யப்படவில்லை. எல்லாம் சரி.
                    alert("வெற்றிகரமாக உள்நுழைந்தீர்கள்!");
                    window.location.href = 'index.html'; // முகப்புப் பக்கத்திற்குச் செல்
                }
                
            } catch (error) {
                // (தவறான பாஸ்வேர்ட் போன்றவை)
                alert("லாகின் செய்யும்போது பிழை: " + error.message);
                loginBtn.disabled = false;
                loginBtn.innerText = "உள்நுழை (Login)";
            }
        }
        
        // --- Logout ---
        function handleLogout() {
            signOut(auth).catch((error) => console.error("Logout Error:", error));
        }

        // --- Auth State Change (மாற்றப்படவில்லை) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // (ஹெடரை அப்டேட் செய்...)
                authStatusNav.innerHTML = `Signed in: ${user.email.substring(0, 10)}...`;
                createGigLink.style.display = 'inline-block';
                myOrdersLink.style.display = 'inline-block';
                messagesLink.style.display = 'inline-block';
                profileLink.style.display = 'inline-block';
                logoutBtn.style.display = 'inline-block';
                // (ஃபார்மை மறை...)
                formContainer.style.maxWidth = '600px';
                registerForm.style.display = 'none';
                loginForm.style.display = 'none';
                toggleContainer.style.display = 'none';
                welcomeBox.style.display = 'block';
                userStatus.innerText = "வரவேற்கிறோம், " + user.email;
            } else {
                // (லாகின் செய்யவில்லை என்றால்...)
                authStatusNav.innerHTML = `<a href="login.html">Login / Register</a>`;
                createGigLink.style.display = 'none';
                myOrdersLink.style.display = 'none';
                messagesLink.style.display = 'none';
                profileLink.style.display = 'none';
                logoutBtn.style.display = 'none';
                formContainer.style.maxWidth = '400px';
                welcomeBox.style.display = 'none';
                toggleContainer.style.display = 'block';
                if (loginForm.style.display !== 'block') {
                    registerForm.style.display = 'block';
                }
            }
        });

        // --- Event Listeners ---
        regBtn.addEventListener('click', handleRegister);
        loginBtn.addEventListener('click', handleLogin);
        toggleLinkBtn.addEventListener('click', toggleForms);
        logoutBtn.addEventListener('click', handleLogout);
        logoutButtonMain.addEventListener('click', handleLogout);

    </script>
</body>
  </html>
