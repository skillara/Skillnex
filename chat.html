<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>படி 18: Real-time Chat</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: #f0f2f5; margin: 0; padding: 0;
            display: flex; flex-direction: column; height: 100vh;
        }
        .header {
            background: #fff; padding: 1rem 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 1.2rem; font-weight: 700; color: #333; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header a { font-size: 0.9rem; font-weight: 500; color: #007bff; }
        
        #loading, #error-msg { text-align: center; font-size: 1.2rem; color: #777; margin-top: 2rem; }

        /* !! Chat Messages Container !! */
        #message-container {
            flex-grow: 1; /* மீதமுள்ள எல்லா இடத்தையும் எடு */
            overflow-y: auto; /* Scrollbar */
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .message {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }
        .message.sent {
            background-color: #007bff; /* நீலம் */
            color: white;
            align-self: flex-end; /* வலது பக்கம் */
            border-bottom-right-radius: 4px;
        }
        .message.received {
            background-color: #e4e6eb; /* சாம்பல் */
            color: #050505;
            align-self: flex-start; /* இடது பக்கம் */
            border-bottom-left-radius: 4px;
        }

        /* !! Chat Input Form !! */
        #chat-form {
            display: none; /* லோட் ஆனதும் JS மூலம் காட்டு */
            flex-shrink: 0;
            background: #fff;
            padding: 1rem;
            border-top: 1px solid #ddd;
            display: flex;
        }
        #message-input {
            flex-grow: 1;
            padding: 0.75rem 1rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 1rem;
            margin-right: 0.5rem;
        }
        #send-btn {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%; /* வட்டம் */
            width: 44px;
            height: 44px;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
        }
        #send-btn:hover { background-color: #0056b3; }
    </style>
</head>
<body>

    <header class="header">
        <span id="chat-header-title">Chat Room</span>
        <a href="index.html">முகப்பு</a>
    </header>

    <p id="loading">Chat-ஐப் பதிவேற்றுகிறது...</p>
    <p id="error-msg" style="display: none;"></p>

    <!-- மெசேஜ்கள் இங்கே தோன்றும் -->
    <div id="message-container">
        <!--
        <div class="message received">Hi Sahan!</div>
        <div class="message sent">Hello! How can I help you?</div>
        -->
    </div>
    
    <!-- மெசேஜ் டைப் செய்யும் இடம் -->
    <form id="chat-form">
        <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
        <button type="submit" id="send-btn">→</button>
    </form>

    <!-- ********************************************** -->
    <!--          FIREBASE JAVASCRIPT SECTION           -->
    <!-- ********************************************** -->

    <script type="module">
        // Import the functions you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        // !! இதுதான் Real-time-இன் ரகசியம்: onSnapshot !!
        import { 
            getFirestore, doc, getDoc, setDoc, collection, addDoc, 
            serverTimestamp, query, orderBy, onSnapshot 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDrcT2_lGYtEtnn3LKvp3M7Ou9rTG95XG8",
            authDomain: "skillnex.firebaseapp.com",
            projectId: "skillnex",
            storageBucket: "skillnex.firebasestorage.app",
            messagingSenderId: "981326730889",
            appId: "1:981326730889:web:a063a71ec8b8d2169d9858",
            measurementId: "G-HN4CVQF3GJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loadingP = document.getElementById('loading');
        const errorMsg = document.getElementById('error-msg');
        const chatForm = document.getElementById('chat-form');
        const messageContainer = document.getElementById('message-container');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        
        let currentUser = null;
        let recipientId = null;
        let chatRoomId = null;

        // --- 1. யூசர் லாகின் சோதித்தல் மற்றும் ID-க்களைப் பெறுதல் ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // URL-ல் இருந்து Seller ID-ஐப் பெறு (படி 17-ல் இருந்து)
                const urlParams = new URLSearchParams(window.location.search);
                recipientId = urlParams.get('recipientId');

                if (!recipientId) {
                    return showError("பிழை: யாருக்கு அனுப்புகிறீர்கள் (Recipient ID) என்று தெரியவில்லை.");
                }
                
                // Seller-இன் பெயரைப் பெற்று, ஹெடரில் காட்டு (Nice-to-have)
                try {
                    const userDoc = await getDoc(doc(db, "users", recipientId));
                    if(userDoc.exists()) {
                        chatHeaderTitle.innerText = `Chat with ${userDoc.data().displayName || userDoc.data().email}`;
                    } else {
                        chatHeaderTitle.innerText = `Chat with ${recipientId.substring(0, 8)}...`;
                    }
                } catch (e) { /* on error, just show title */ }


                // --- 2. ரகசிய Chat Room ID-ஐ உருவாக்குதல் ---
                // அகர வரிசைப்படி ID-க்களை இணைத்தல்
                chatRoomId = [currentUser.uid, recipientId].sort().join('_');
                
                // Chat-ஐத் தொடங்கு!
                loadingP.style.display = 'none';
                chatForm.style.display = 'flex'; // Chat ஃபார்மைக் காட்டு
                
                // பழைய மெசேஜ்களை லோட் செய், புதிய மெசேஜ்களுக்குக் காத்திரு
                loadAndListenMessages();

            } else {
                showError("Chat செய்ய, நீங்கள் <a href='login.html'>லாகின்</a> செய்திருக்க வேண்டும்.");
            }
        });

        // --- 3. மெசேஜ்களை அனுப்பும் செயல்பாடு ---
        async function sendMessage(e) {
            e.preventDefault(); // பக்கத்தை Refresh செய்யாதே
            const messageText = messageInput.value;
            
            if (messageText.trim() === "" || !chatRoomId) {
                return; // காலி மெசேஜ் அனுப்ப வேண்டாம்
            }

            messageInput.value = ""; // Input-ஐ உடனே காலி செய்

            try {
                // மெசேஜை `chats/CHAT_ROOM_ID/messages` என்ற Sub-collection-ல் சேமி
                const messagesRef = collection(db, "chats", chatRoomId, "messages");
                await addDoc(messagesRef, {
                    text: messageText,
                    senderId: currentUser.uid,
                    createdAt: serverTimestamp()
                });

                // படி 19-க்காக (Inbox): Chat ரூமின் "கடைசி மெசேஜ்"-ஐ அப்டேட் செய்
                const chatRoomRef = doc(db, "chats", chatRoomId);
                await setDoc(chatRoomRef, {
                    participants: [currentUser.uid, recipientId],
                    lastMessage: messageText,
                    lastMessageAt: serverTimestamp()
                }, { merge: true }); // 'merge: true' என்பது முக்கியம்

            } catch (error) {
                console.error("Error sending message:", error);
                // அனுப்பிய மெசேஜை மீண்டும் Input-ல் காட்டு (பிழை)
                messageInput.value = messageText;
                alert("மெசேஜ் அனுப்புவதில் பிழை!");
            }
        }
        
        // --- 4. மெசேஜ்களை Real-time-ல் பெறும் செயல்பாடு ---
        function loadAndListenMessages() {
            const messagesRef = collection(db, "chats", chatRoomId, "messages");
            // புதிதாக வருபவை (ASC) வரிசைப்படி கேள்
            const q = query(messagesRef, orderBy("createdAt", "asc"));

            // !! இதுதான் Real-time "மூளை": onSnapshot !!
            onSnapshot(q, (querySnapshot) => {
                messageContainer.innerHTML = ''; // பழைய மெசேஜ்களை அழி
                
                querySnapshot.forEach((doc) => {
                    const messageData = doc.data();
                    
                    // HTML-ல் மெசேஜைக் காட்டு
                    const messageElement = document.createElement('div');
                    messageElement.className = 'message';
                    
                    // நீங்கள் அனுப்பியதா? அல்லது பெற்றதா?
                    if (messageData.senderId === currentUser.uid) {
                        messageElement.classList.add('sent');
                    } else {
                        messageElement.classList.add('received');
                    }
                    
                    messageElement.innerText = messageData.text;
                    messageContainer.appendChild(messageElement);
                });
                
                // புதிய மெசேஜ் வந்ததும், ஸ்க்ரோல் செய்து கீழே செல்
                messageContainer.scrollTop = messageContainer.scrollHeight;
            });
        }

        function showError(message) {
            loadingP.style.display = 'none';
            chatForm.style.display = 'none';
            errorMsg.innerHTML = message;
            errorMsg.style.display = 'block';
        }

        // --- Event Listeners ---
        chatForm.addEventListener('submit', sendMessage); // Enter அல்லது Send பட்டன்

    </script>
</body>
</html>
