<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkillNex - முகப்பு (Search)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        
        /* ஹெடர் (Header) ஸ்டைல் */
        .header {
            background: #fff; padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: #333; }
        .nav { display: flex; align-items: center; }
        .nav a { color: #007bff; text-decoration: none; margin-left: 1.5rem; font-weight: 500; }
        #auth-status-nav a { color: #28a745; }
        #logout-btn { color: #dc3545; cursor: pointer; }

        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        h1 { color: #333; }
        
        /* !! படி 16: புதிய Search Bar ஸ்டைல் !! */
        .search-container {
            margin-bottom: 2rem;
        }
        #search-input {
            width: 100%;
            padding: 1rem;
            font-size: 1.2rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box; /* padding-ஐ உள்ளடக்க */
        }
        
        /* Gig கார்டு ஸ்டைல் */
        #gigs-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .gig-card-link {
            text-decoration: none; color: inherit; display: block;
            background: #fff; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden; transition: transform 0.2s;
        }
        .gig-card-link:hover { transform: translateY(-5px); }
        .gig-card-link img { width: 100%; height: 180px; object-fit: cover; background-color: #eee; }
        .gig-content { padding: 1rem; }
        .gig-title { font-size: 1.2rem; font-weight: 600; color: #333; margin: 0 0 0.5rem 0; }
        .gig-description {
            font-size: 0.9rem; color: #555; height: 40px; overflow: hidden;
            text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .gig-footer {
            padding: 1rem; border-top: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .gig-price { font-size: 1.25rem; font-weight: 700; color: #28a745; }
        .gig-price span { font-size: 0.9rem; font-weight: 400; color: #777; }
        
        #loading, #no-results { text-align: center; font-size: 1.2rem; color: #777; margin-top: 3rem; }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">SkillNex</div>
        <nav class="nav">
            <a href="index.html"><b>முகப்பு (Home)</b></a>
            <span id="auth-status-nav">
                <a href="login.html">Login / Register</a>
            </span>
            <a id="create-gig-link" href="create-gig.html" style="display: none;">Gig-ஐ உருவாக்கு</a>
            <a id="my-orders-link" href="my-orders.html" style="display: none;">எனது ஆர்டர்கள்</a>
            <a id="profile-link" href="profile.html" style="display: none;">சுயவிவரம்</a>
            <a id="logout-btn" style="display: none;">வெளியேறு (Logout)</a>
        </nav>
    </header>

    <main class="container">
        
        <div class="search-container">
            <input type="search" id="search-input" placeholder="என்ன சேவை தேடுகிறீர்கள்? (e.g., logo, web)...">
        </div>

        <h1>கிடைக்கும் சேவைகள் (Available Gigs)</h1>
        
        <div id="gigs-container">
            </div>

        <p id="loading">சேவைகளைப் பதிவேற்றுகிறது...</p>
        <p id="no-results" style="display: none;">நீங்கள் தேடிய "<span></span>" என்ற சொல்லுக்கு Gigs எதுவும் இல்லை.</p>

    </main>

    <script type="module">
        // Import the functions you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDrcT2_lGYtEtnn3LKvp3M7Ou9rTG95XG8",
            authDomain: "skillnex.firebaseapp.com",
            projectId: "skillnex",
            storageBucket: "skillnex.firebasestorage.app",
            messagingSenderId: "981326730889",
            appId: "1:981326730889:web:a063a71ec8b8d2169d9858",
            measurementId: "G-HN4CVQF3GJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        // Header
        const authStatusNav = document.getElementById('auth-status-nav');
        const createGigLink = document.getElementById('create-gig-link');
        const myOrdersLink = document.getElementById('my-orders-link');
        const profileLink = document.getElementById('profile-link');
        const logoutBtn = document.getElementById('logout-btn');
        // Page Content
        const gigsContainer = document.getElementById('gigs-container');
        const loadingP = document.getElementById('loading');
        // Search (புதியது)
        const searchInput = document.getElementById('search-input');
        const noResultsP = document.getElementById('no-results');
        
        // !! படி 16: Search Logic-காக ஒரு Global Array !!
        let allGigs = []; // எல்லா Gig-களையும் ஒருமுறை சேமிக்க

        // --- யூசர் லாகின் சோதித்தல் (ஹெடருக்காக) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authStatusNav.innerHTML = `Signed in: ${user.email.substring(0, 10)}...`;
                createGigLink.style.display = 'inline-block';
                myOrdersLink.style.display = 'inline-block';
                profileLink.style.display = 'inline-block';
                logoutBtn.style.display = 'inline-block';
            } else {
                authStatusNav.innerHTML = `<a href="login.html">Login / Register</a>`;
                createGigLink.style.display = 'none';
                myOrdersLink.style.display = 'none';
                profileLink.style.display = 'none';
                logoutBtn.style.display = 'none';
            }
        });

        // --- Logout செயல்பாடு ---
        logoutBtn.addEventListener('click', () => {
            signOut(auth).catch((error) => console.error("Logout Error:", error));
        });

        // --- 1. Firestore-ல் இருந்து *எல்லா* Gigs-களையும் ஒருமுறை பெறுதல் ---
        async function fetchAllGigs() {
            try {
                const gigsQuery = query(collection(db, "gigs"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(gigsQuery);
                
                loadingP.style.display = 'none';
                
                if (querySnapshot.empty) {
                    loadingP.innerText = "தற்போது Gigs எதுவும் இல்லை.";
                    loadingP.style.display = 'block';
                    return;
                }
                
                // ஒவ்வொரு Gig-ஐயும் `allGigs` Array-ல் சேமி
                querySnapshot.forEach((doc) => {
                    allGigs.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // சேமித்த பிறகு, முதல் முறை எல்லாவற்றையும் காட்டு
                renderGigs(allGigs);

            } catch (error) {
                console.error("Error fetching gigs: ", error);
                loadingP.innerText = "Gigs-களைப் பெறுவதில் பிழை ஏற்பட்டது.";
            }
        }

        // --- 2. Gigs-களை HTML-ல் காட்டும் செயல்பாடு (புதியது) ---
        // இது இப்போது ஒரு தனி Function. தேடலுக்காக.
        function renderGigs(gigsToRender) {
            gigsContainer.innerHTML = ''; // பழையதை அழி
            
            if (gigsToRender.length === 0) {
                // தேடல் முடிவுகள் இல்லை என்றால்...
                const searchText = searchInput.value;
                noResultsP.querySelector('span').innerText = `"${searchText}"`;
                noResultsP.style.display = 'block';
            } else {
                noResultsP.style.display = 'none';
            }

            gigsToRender.forEach((gigData) => {
                const gigCardLink = document.createElement('a');
                gigCardLink.className = 'gig-card-link';
                gigCardLink.href = `gig-details.html?id=${gigData.id}`; 
                
                gigCardLink.innerHTML = `
                    <img src="https://via.placeholder.com/300x180?text=${encodeURIComponent(gigData.title)}" alt="Gig Image">
                    <div class="gig-content">
                        <h3 class="gig-title">${gigData.title}</h3>
                        <p class="gig-description">${gigData.description}</p>
                    </div>
                    <div class="gig-footer">
                        <span class="gig-price"><span>Starting at</span> $${gigData.price}</span>
                    </div>
                `;
                gigsContainer.appendChild(gigCardLink);
            });
        }
        
        // --- 3. Search Input-க்கான Event Listener (புதியது) ---
        searchInput.addEventListener('input', (e) => {
            const searchText = e.target.value.toLowerCase(); // டைப் செய்ததை Small letter-ல் எடு

            // `allGigs` Array-ஐ Filter செய்
            const filteredGigs = allGigs.filter((gig) => {
                // தலைப்பு (Title) அல்லது விளக்கத்தில் (Description) தேடல் சொல் இருக்கிறதா?
                return gig.title.toLowerCase().includes(searchText) || 
                       gig.description.toLowerCase().includes(searchText);
            });
            
            // Filter செய்த Gig-களை மட்டும் காட்டு
            renderGigs(filteredGigs);
        });

        // --- பக்கம் லோட் ஆனதும், Gigs-களைப் பெற இந்தச் செயல்பாட்டை இயக்கு ---
        fetchAllGigs();

    </script>
</body>
</html>
