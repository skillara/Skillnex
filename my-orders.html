<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>படி 30: எனது ஆர்டர்கள் (Final Status)</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        .header { background: #fff; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .logo { font-size: 1.5rem; font-weight: 700; color: #333; }
        .nav { float: right; }
        .nav a { color: #007bff; text-decoration: none; margin-left: 1.5rem; font-weight: 500; }

        .container { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
        h2 { border-bottom: 2px solid #ddd; padding-bottom: 0.5rem; }
        
        #login-prompt { background: #fff; padding: 2rem; border-radius: 8px; text-align: center; border: 2px solid #dc3545; color: #dc3545; }

        .orders-list { margin-bottom: 2rem; }
        .order-item {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 1rem;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .order-item-details { flex-grow: 1; }
        .order-item-details h3 { margin: 0 0 0.5rem 0; }
        .order-item-details p { margin: 0.25rem 0; color: #555; }
        .order-item-status {
            text-align: right; /* வலது பக்கம் தள்ளு */
            flex-shrink: 0; /* சுருங்க வேண்டாம் */
            margin-left: 1rem;
        }
        .status-badge {
            font-weight: 700;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: block;
        }
        
        /* !! படி 30.C: புதிய ஸ்டேட்டஸ் நிறங்கள் !! */
        .status-pending_confirmation { background-color: #fffbef; color: #856404; } /* மஞ்சள் */
        .status-in_progress { background-color: #e2f0ff; color: #004085; } /* நீலம் */
        .status-delivered { background-color: #fffbef; color: #856404; } /* மஞ்சள் */
        .status-completed { background-color: #e6f9f0; color: #155724; } /* பச்சை */
        .status-disputed { background-color: #fbeae5; color: #dc3545; } /* சிவப்பு */
        .status-refunded { background-color: #e4e6eb; color: #383d41; } /* சாம்பல் */
        .status-paid { background-color: #e6f9f0; color: #155724; } /* பச்சை (Seller View) */


        /* பட்டன்கள் */
        .deliver-btn { background-color: #28a745; color: white; ... }
        .review-btn { background-color: #007bff; color: white; ... }

        @media (max-width: 600px) {
            .order-item { flex-direction: column; align-items: flex-start; }
            .order-item-status { margin-top: 1rem; margin-left: 0; text-align: left; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">SkillNex</div>
        <nav class="nav">
            <a href="index.html">முகப்பு (Home)</a>
            <a href="messages.html">மெசேஜ்கள்</a>
            <a href="my-orders.html"><b>எனது ஆர்டர்கள்</b></a>
            <a href="profile.html">சுயவிவரம்</a>
            <a id="logout-btn" style="cursor: pointer; color: #dc3545;">வெளியேறு</a>
        </nav>
    </header>

    <main class="container">
        
        <div id="login-prompt" style="display: none;">
            </div>
        
        <div id="orders-content" style="display: none;">
            
            <div class="orders-list">
                <h2>நான் வாங்கியவை (My Purchases)</h2>
                <div id="buyer-orders-container">
                    <p id="loading-buyer">வாங்கிய ஆர்டர்களைப் பதிவேற்றுகிறது...</p>
                </div>
            </div>
            
            <div class="orders-list">
                <h2>நான் விற்பவை (My Sales)</h2>
                <div id="seller-orders-container">
                    <p id="loading-seller">விற்பனைக்கான ஆர்டர்களைப் பதிவேற்றுகிறது...</p>
                </div>
            </div>

        </div>

    </main>

    <script type="module">
        // Import the functions you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase Config... (மாற்றப்படவில்லை)
        const firebaseConfig = {
            apiKey: "AIzaSyDrcT2_lGYtEtnn3LKvp3M7Ou9rTG95XG8",
            authDomain: "skillnex.firebaseapp.com",
            projectId: "skillnex",
            storageBucket: "skillnex.firebasestorage.app",
            messagingSenderId: "981326730889",
            appId: "1:981326730889:web:a063a71ec8b8d2169d9858",
            measurementId: "G-HN4CVQF3GJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // DOM Elements
        const loginPromptDiv = document.getElementById('login-prompt');
        const ordersContentDiv = document.getElementById('orders-content');
        const buyerContainer = document.getElementById('buyer-orders-container');
        const sellerContainer = document.getElementById('seller-orders-container');
        const loadingBuyerP = document.getElementById('loading-buyer');
        const loadingSellerP = document.getElementById('loading-seller');
        const logoutBtn = document.getElementById('logout-btn');

        // --- 1. யூசர் லாகின் சோதித்தல் ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginPromptDiv.style.display = 'none';
                ordersContentDiv.style.display = 'block';
                fetchAllOrders(user.uid);
            } else {
                loginPromptDiv.style.display = 'block';
                ordersContentDiv.style.display = 'none';
            }
        });

        // --- 2. ஆர்டர்களைப் பெறும் (Buyer & Seller) செயல்பாடு ---
        async function fetchAllOrders(currentUserId) {
            fetchOrders("buyerId", currentUserId, buyerContainer, loadingBuyerP);
            fetchOrders("sellerId", currentUserId, sellerContainer, loadingSellerP);
        }

        async function fetchOrders(fieldToQuery, userId, container, loadingElement) {
            try {
                const q = query(collection(db, "orders"), 
                                where(fieldToQuery, "==", userId),
                                orderBy("createdAt", "desc"));
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    loadingElement.innerText = "இந்த நிலையில் ஆர்டர்கள் எதுவும் இல்லை.";
                    return;
                }

                loadingElement.style.display = 'none';
                container.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const orderData = doc.data();
                    const orderId = doc.id;
                    
                    const orderItem = document.createElement('div');
                    orderItem.className = 'order-item';
                    
                    // ===============================================
                    // !! படி 30.C: முழுமையான ஸ்டேட்டஸ் லாஜிக் !!
                    // ===============================================
                    let statusText = orderData.status;
                    if (statusText === 'pending_confirmation') statusText = "பணம் உறுதிப்படுத்தப்படவில்லை";
                    if (statusText === 'in_progress') statusText = "வேலை நடக்கிறது";
                    if (statusText === 'delivered') statusText = "வேலை டெலிவரி செய்யப்பட்டது";
                    if (statusText === 'completed') statusText = "ஆர்டர் முடிந்தது";
                    if (statusText === 'disputed') statusText = "பிரச்சினையில் உள்ளது (Disputed)";
                    if (statusText === 'refunded') statusText = "பணம் திரும்ப அளிக்கப்பட்டது (Refunded)";
                    if (statusText === 'paid') statusText = "பணம் அனுப்பப்பட்டது (Paid)";
                    // ===============================================

                    let otherPartyText = '';
                    if (fieldToQuery === 'buyerId') {
                        otherPartyText = `<p>Seller ID: ${orderData.sellerId.substring(0, 8)}...</p>`;
                    } else {
                        otherPartyText = `<p>Buyer: ${orderData.buyerEmail}</p>`;
                    }
                    
                    let actionButtonHtml = '';
                    // Seller-க்கான பட்டன்
                    if (fieldToQuery === 'sellerId' && orderData.status === 'in_progress') {
                        actionButtonHtml = `<a href="deliver-work.html?orderId=${orderId}" class="deliver-btn">வேலையை டெலிவரி செய்</a>`;
                    }
                    // Buyer-க்கான பட்டன்
                    if (fieldToQuery === 'buyerId' && orderData.status === 'delivered') {
                        actionButtonHtml = `<a href="review-delivery.html?orderId=${orderId}" class="review-btn">வேலையைப் பார்த்து & ஏற்றுக்கொள்</a>`;
                    }
                    // Buyer-க்கான ரிவ்யூ பட்டன் (Completed)
                    if (fieldToQuery === 'buyerId' && orderData.status === 'completed') {
                        // TODO: ரிவ்யூ கொடுக்கப்பட்டுவிட்டதா என்று சோதித்து, பட்டனை மறைக்கலாம்.
                        actionButtonHtml = `<a href="leave-review.html?orderId=${orderId}" class="review-btn" style="background-color: #6c757d;">ரிவ்யூ கொடு</a>`;
                    }


                    orderItem.innerHTML = `
                        <div class="order-item-details">
                            <h3>${orderData.gigTitle}</h3>
                            <p>விலை: <strong>$${orderData.price}</strong> | பேக்கேஜ்: <strong>${orderData.package || 'basic'}</strong></p>
                            ${otherPartyText}
                            <p>Order ID: <code>${orderId}</code></p>
                        </div>
                        <div class="order-item-status">
                            <span class="status-badge status-${orderData.status}">
                                ${statusText}
                            </span>
                            ${actionButtonHtml}
                        </div>
                    `;
                    container.appendChild(orderItem);
                });

            } catch (error) {
                console.error(`Error fetching orders:`, error);
                loadingElement.innerText = "ஆர்டர்களைப் பெறுவதில் பிழை ஏற்பட்டது.";
            }
        }
        
        // --- 3. Logout செயல்பாடு ---
        logoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                alert("வெளியேறிவிட்டீர்கள்.");
                window.location.href = 'index.html';
            }).catch((error) => console.error("Logout Error:", error));
        });

    </script>
</body>
              </html>
