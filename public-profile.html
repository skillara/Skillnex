<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>படி 27: Seller சுயவிவரம்</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
        
        .header {
            background: #fff; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-size: 1.5rem; font-weight: 700; color: #333; }
        .nav a { color: #007bff; text-decoration: none; margin-left: 1.5rem; font-weight: 500; }

        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        
        /* !! படி 27: புதிய Profile Card ஸ்டைல் !! */
        .profile-card {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        #seller-name {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        #seller-skills {
            font-size: 1.1rem;
            color: #555;
            margin-top: 0.5rem;
        }
        
        /* Gig Card ஸ்டைல் (index.html-ல் இருந்து காப்பி) */
        #gigs-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .gig-card-link {
            text-decoration: none; color: inherit; display: block;
            background: #fff; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            overflow: hidden; transition: transform 0.2s;
        }
        .gig-card-link img { width: 100%; height: 180px; object-fit: cover; background-color: #eee; }
        .gig-content { padding: 1rem; }
        .gig-category {
            font-size: 0.8rem; font-weight: 600; color: #007bff;
            background-color: #e6f2ff; padding: 0.25rem 0.5rem;
            border-radius: 4px; display: inline-block; margin-bottom: 0.5rem;
        }
        .gig-title { font-size: 1.2rem; font-weight: 600; color: #333; margin: 0; }
        .gig-footer {
            padding: 1rem; border-top: 1px solid #f0f0f0;
            text-align: right;
        }
        .gig-price { font-size: 1.25rem; font-weight: 700; color: #28a745; }
        .gig-price span { font-size: 0.9rem; font-weight: 400; color: #777; }
        
        #loading-profile, #loading-gigs { text-align: center; font-size: 1.2rem; color: #777; margin-top: 3rem; }
    </style>
</head>
<body>

    <header class="header">
        <div class="logo">SkillNex</div>
        <nav class="nav">
            <a href="index.html">முகப்பு (Home)</a>
            <a href="my-orders.html">எனது ஆர்டர்கள்</a>
            <a href="profile.html">சுயவிவரம்</a>
        </nav>
    </header>

    <main class="container">
        
        <div class="profile-card">
            <p id="loading-profile">Seller-இன் சுயவிவரத்தைப் பதிவேற்றுகிறது...</p>
            <h1 id="seller-name" style="display: none;"></h1>
            <p id="seller-skills" style="display: none;"></p>
        </div>

        <h2><span id="seller-name-title">Seller</span>'s Gigs</h2>
        <div id="gigs-container">
            </div>
        <p id="loading-gigs">Seller-இன் Gigs-களைப் பதிவேற்றுகிறது...</p>

    </main>

    <script type="module">
        // Import the functions you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        // Auth தேவையில்லை, இது Public பக்கம்.
        import { getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Firebase Config...
        const firebaseConfig = {
            apiKey: "AIzaSyDrcT2_lGYtEtnn3LKvp3M7Ou9rTG95XG8",
            authDomain: "skillnex.firebaseapp.com",
            projectId: "skillnex",
            storageBucket: "skillnex.firebasestorage.app",
            messagingSenderId: "981326730889",
            appId: "1:981326730889:web:a063a71ec8b8d2169d9858",
            measurementId: "G-HN4CVQF3GJ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const loadingProfileP = document.getElementById('loading-profile');
        const sellerNameEl = document.getElementById('seller-name');
        const sellerSkillsEl = document.getElementById('seller-skills');
        const sellerNameTitle = document.getElementById('seller-name-title');
        
        const gigsContainer = document.getElementById('gigs-container');
        const loadingGigsP = document.getElementById('loading-gigs');

        // --- 1. URL-ல் இருந்து Seller ID-ஐப் பெறுதல் ---
        const urlParams = new URLSearchParams(window.location.search);
        const sellerId = urlParams.get('id');

        if (!sellerId) {
            loadingProfileP.innerText = "பிழை: Seller ID கிடைக்கவில்லை.";
            loadingGigsP.style.display = 'none';
        }

        // --- 2. Seller-இன் சுயவிவரத்தைப் பெறுதல் (படி 10.5-ல் இருந்து) ---
        async function fetchSellerProfile() {
            try {
                const docRef = doc(db, "users", sellerId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    const displayName = userData.displayName || userData.email.split('@')[0];
                    
                    sellerNameEl.innerText = displayName;
                    sellerNameTitle.innerText = displayName;
                    sellerSkillsEl.innerText = userData.skills || "Skills not listed.";
                    
                    loadingProfileP.style.display = 'none';
                    sellerNameEl.style.display = 'block';
                    sellerSkillsEl.style.display = 'block';
                } else {
                    loadingProfileP.innerText = "இந்த Seller இல்லை.";
                }
            } catch (error) {
                console.error("Error fetching profile:", error);
                loadingProfileP.innerText = "சுயவிவரத்தைப் பெறுவதில் பிழை.";
            }
        }

        // --- 3. Seller-இன் Gigs-களைப் பெறுதல் (படி 22-ல் இருந்து) ---
        async function fetchSellerGigs() {
            try {
                // "gigs" collection-ஐத் தேடு...
                const q = query(collection(db, "gigs"), 
                                // ...அங்கே sellerId == இந்த ID
                                where("sellerId", "==", sellerId),
                                // ...மற்றும் Approve ஆக இருக்க வேண்டும்
                                where("isApproved", "==", true),
                                orderBy("createdAt", "desc"));
                
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    loadingGigsP.innerText = "இந்த Seller-க்கு Gigs எதுவும் இல்லை.";
                    return;
                }

                loadingGigsP.style.display = 'none';
                gigsContainer.innerHTML = '';

                querySnapshot.forEach((doc) => {
                    const gigData = doc.data();
                    const gigId = doc.id;
                    
                    // index.html-ல் இருந்து அதே விலைக் கணக்கீடு
                    let startingPrice = '--';
                    if (gigData.pricing && gigData.pricing.basic && gigData.pricing.basic.price) {
                        startingPrice = gigData.pricing.basic.price;
                    }
                    
                    const gigCardLink = document.createElement('a');
                    gigCardLink.className = 'gig-card-link';
                    gigCardLink.href = `gig-details.html?id=${gigId}`; 
                    let categoryText = gigData.category.replace('_', ' ');
                    
                    gigCardLink.innerHTML = `
                        <img src="https://via.placeholder.com/300x180?text=${encodeURIComponent(gigData.title)}" alt="Gig Image">
                        <div class="gig-content">
                            <span class="gig-category">${categoryText}</span>
                            <h3 class="gig-title">${gigData.title}</h3>
                        </div>
                        <div class="gig-footer">
                            <span class="gig-price"><span>Starting at</span> $${startingPrice}</span>
                        </div>
                    `;
                    gigsContainer.appendChild(gigCardLink);
                });

            } catch (error) {
                console.error("Error fetching seller gigs:", error);
                loadingGigsP.innerText = "Seller-இன் Gigs-களைப் பெறுவதில் பிழை.";
            }
        }

        // --- பக்கத்தை லோட் செய் ---
        if (sellerId) {
            fetchSellerProfile();
            fetchSellerGigs();
        }
    </script>
</body>
</html>
